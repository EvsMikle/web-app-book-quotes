package comm.octest.db;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.List;

import comm.octest.beans.Observer;
import comm.octest.beans.User;

public class UserDAO {
	
	Connection connexion = null;
	Statement statement = null;
	ResultSet resultat = null;
	
	
	
	
	public void driver() {
		try {
			Class.forName("com.mysql.jdbc.Driver");
			connexion = DriverManager.getConnection("jdbc:mysql://localhost:3306/goodQuotes", "root", "");
			System.out.println("Connexion reussite ");
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	     //AUTHENTIFICATION 
		public boolean authentification(Observer user) {
			String email = user.getEmail();
			String password = user.getPassword();
			System.out.println("authentification :" + email);
			boolean auth = false;
			try {
				driver();
				PreparedStatement preparedStatement = connexion
						.prepareStatement("SELECT password FROM users WHERE email = ?");
				preparedStatement.setString(1, email);
				ResultSet resultat = preparedStatement.executeQuery();

				if (resultat.next()) {
					String passwordBb = resultat.getString("password");
					if (password.equals(passwordBb)) {
						auth = true;
					}
				} else {
					auth = false;
				}
			} catch (SQLException e) {
				e.printStackTrace();

			}
			return auth;
		}
		
		
		// GET INFORMATION OF A USER
		public List<User> getUser(String email, int idUserConnected) throws SQLException {
			List<User> userInfo = new ArrayList<>();
			boolean isFriends;
			int nbreFriends;

			driver();
			PreparedStatement preparedStatement3 = connexion.prepareStatement(
					"SELECT u.*, COUNT(CASE WHEN uq.id_user IS NOT NULL THEN 1 ELSE 0 END) AS nbreQuotes, COUNT(CASE WHEN lk.id_quote IS NOT NULL THEN 1 ELSE 0 END)  as nbreOfLikes FROM users u LEFT JOIN user_quote uq ON u.id_user = uq.id_user LEFT JOIN like_quote lk ON uq.id_quote = lk.id_quote  WHERE email =? GROUP BY u.id_user   ");
			preparedStatement3.setString(1, email);

			ResultSet resultat3 = preparedStatement3.executeQuery();

			if (resultat3.next()) {
				String full_name = resultat3.getString("full_name");
				String country = resultat3.getString("country");
				String city = resultat3.getString("city");
				String emailProfile = resultat3.getString("email");
				String password = resultat3.getString("password");
				Timestamp created_at = resultat3.getTimestamp("created_at");
				int nbreQuotes = resultat3.getInt("nbreQuotes");
				int id_user = resultat3.getInt("id_user");
				int nbre_likes = resultat3.getInt("nbreOfLikes");

				PreparedStatement preparedStatement4 = connexion.prepareStatement(
						"SELECT COUNT(*) as nbreOfFriends FROM friendships WHERE id_user1 =? or id_user2=? ");

				preparedStatement4.setInt(1, id_user);
				preparedStatement4.setInt(2, id_user);

				ResultSet resultat4 = preparedStatement4.executeQuery();

				PreparedStatement preparedStatement5 = connexion.prepareStatement(
						"SELECT * FROM friendships WHERE id_user1 =?  AND id_user2 =? or id_user2=? AND id_user1=?");
				preparedStatement5.setInt(1, idUserConnected);
				preparedStatement5.setInt(2, id_user);
				preparedStatement5.setInt(3, idUserConnected);
				preparedStatement5.setInt(4, id_user);

				ResultSet resultat5 = preparedStatement5.executeQuery();

				if (resultat4.next()) {
					nbreFriends = resultat4.getInt("nbreOfFriends");

				} else {

					nbreFriends = 0;

				}

				if (resultat5.next()) {
					isFriends = true;

				} else {
					isFriends = false;

				}
				User user = new User(full_name, country, city, password, created_at, emailProfile, nbreQuotes, id_user,
						nbreFriends, nbre_likes, isFriends);
				userInfo.add(user);
			}
			return userInfo;
		}
		
		// UPDATE USER INFO
public void updateUserInfo(Observer user) throws SQLException {
			String full_name = user.getName();
			String email = user.getEmail();
			String country = user.getCountry();
			String city = user.getCity();
			String password = user.getPassword();
			int id_user = user.getId_user();

			driver();
			PreparedStatement preparedStatement = connexion
					.prepareStatement("UPDATE users SET full_name = ?,email=?,country=?,city=?,password=? WHERE id_user=?");
			preparedStatement.setString(1, full_name);
			preparedStatement.setString(2, email);
			preparedStatement.setString(3, country);
			preparedStatement.setString(4, city);
			preparedStatement.setString(5, password);
			preparedStatement.setInt(6, id_user);
			preparedStatement.executeUpdate();

		}
		
		

}
