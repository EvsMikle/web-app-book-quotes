package comm.octest.beans;

import java.sql.SQLException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class QuoteFactory implements I_Quote {
	private Map<String, Flyweight> quotes = new HashMap<>();
	private Map<String, Integer> user_quotes = new HashMap<>();
	private Flyweight quote;
	private List<Observer> observers;
	// private static I_Quote quoteFactory = QuoteFactorySingleton.getInstance();

	public QuoteFactory() {
		quote = new QuoteManager();
		observers = new ArrayList<>();
	}

	public QuoteFactory(int nothing) {
		quote = new QuoteManager();
	}

	public Flyweight addQuote(String name_book, String quote_text, int userId) throws SQLException {
		// CREATE THE KEYS
		String key = name_book + quote_text;
		String key2 = quote_text + userId;

		// REMPLISSAGE DES MAPS AVEC LE CONTENUE DE LA BASE DE DONNEE
		fetchQuotes(userId);
		addUserIds();

		// SEARCHING FOR THE QUOTE IF IT EXISTS IN THE QUOTES MAP
		quote = (QuoteManager) quotes.get(key);
		// IF NOT WE ADD IT AND WE INSERT IT IN THE DB
		if (quote == null) {
			quote = new QuoteManager(name_book, quote_text, userId);
			putQuote(key, quote);
			int id_quote = quote.insertQuote();
			QuoteFactorySingleton.getInstance().notifyObservers(id_quote);
		}

		if (!user_quotes.containsKey(key2)) {
			System.out.println("quoteAuthorship isnt the same");
			user_quotes.put(key2, userId);
			if (quote != null) {
				quote = new QuoteManager(name_book, quote_text, userId);
				int id_quote = quote.insertQuoteAuthorship();
				QuoteFactorySingleton.getInstance().notifyObservers(id_quote);
			} else if (quote == null) {
				quote.insertQuoteAuthorship();
			}

		}

		return quote;
	}

	public void addUserIds() throws SQLException {
		List<QuoteManager> userQuoteList = quote.fetchQuoteAuthorship();
		for (QuoteManager userQuote : userQuoteList) {
			String quote_text = userQuote.getQuoteText();
			int user_id = userQuote.getUserId();
			String key = quote_text + user_id;
			user_quotes.put(key, user_id);
		}

	}

	public void fetchQuotes(int user_id) throws SQLException {

		List<QuoteManager> fetchedQuotes = quote.fetchQuotes(user_id);
		for (QuoteManager q : fetchedQuotes) {
			String name_book = q.getName_book();
			String quote_text = q.getQuoteText();
			String key = name_book + quote_text;
			putQuote(key, quote);

		}
	}

	// ADD A QUOTE FROM THE MAP
	public void putQuote(String key, Flyweight quote) {
		quotes.put(key, quote);

	}

	// REMOVE A QUOTE FROM THE MAP
	public void removeQuote(String key, QuoteManager quote) {
		quotes.remove(key);
	}

	// ADD OBSERVERS
	public void addObservers(Observer user) {
		if (observers != null) {
			observers.add(user);
		} else {
			System.out.println("user == null ");
		}

	}

	// REMOVE OBSERVERS
	public void removeObserver(Observer user) {
		observers.remove(user);
	}

	// GET OBSERVERS
	public void getObservers() {

		for (Observer ob : observers) {

			System.out.println("observers please : " + ob.getEmail());
		}
	}

	// NOTIFY THE OBSERVER THAT THE THERE HAS BEEN A CHANGE
	public void notifyObservers(int id_quote) throws SQLException {

		for (Observer ob : observers) {
			System.out.println("observers please : " + ob.getEmail());
			ob.sendNotification(id_quote);
		}
	}
}
